<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Com5a8</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #32CD32;
            color: white;
            padding: 10px;
            text-align: center;
        }

        .header p {
            margin: 0;
            color: red;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #32CD32;
            padding: 10px;
            color: white;
        }

        .top-bar div {
            display: flex;
            align-items: center;
        }

        .top-bar a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
        }

        .categories {
            display: flex;
            justify-content: center;
            gap: 15px;
            background-color: #32CD32;
            padding: 10px;
        }

        .categories a {
            text-decoration: none;
            color: white;
            font-weight: bold;
        }

        .products {
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
            gap: 10px;
            background-color: #ffffff;
        }

        .product {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f0fff0;
            flex: 1 1 calc(25% - 20px);
            text-align: center;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .product img {
            max-width: 100%;
            height: auto;
            border-radius: 10px 10px 0 0;
        }

        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .product-details span {
            font-weight: bold;
        }

        .icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .admin-panel {
            display: none;
            padding: 10px;
            background-color: #ffffff;
        }

        .admin-panel .product-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-panel .product-item {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f0fff0;
            flex: 1 1 calc(25% - 20px);
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .admin-panel .product-item img {
            max-width: 100%;
            height: auto;
            border-radius: 10px 10px 0 0;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Com5a8</h1>
        <p>L'alcool à partir de 3 $</p>
    </div>
    <div class="top-bar">
        <div id="horloge"></div>
        <div>
            <a href="#">Compte</a>
            <a href="#">Favoris</a>
            <a href="#" id="panier-button">Panier</a>
        </div>
    </div>
    <div class="categories" id="BarreCategorie"></div>
    <div class="products" id="product-container"></div>
    <div id="ical" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="close-modal-button">&times;</span>
                <h2>Panier de Sélection</h2>
            </div>
            <div class="modal-body" id="ical-panier"></div>
            <div class="modal-footer">
                <button id="pay-button">Payer</button>
            </div>
        </div>
    </div>
    <div id="panier-section" class="hidden"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="http://localhost:8180/js/keycloak.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var keycloak;

            function initKeycloak() {
                keycloak = new Keycloak({
                    "realm": "usager",
                    "auth-server-url": "http://localhost:8180/",
                    "ssl-required": "external",
                    "clientId": "frontend",
                    "public-client": true,
                    "confidential-port": 0
                });
                keycloak.init({ onLoad: 'login-required' }).then(function (authenticated) {
                    console.log(authenticated ? 'authenticated' : 'not authenticated');
                    if (authenticated) {
                        if (keycloak.hasRealmRole('client')) {
                            requestclient();
                        }
                        if (keycloak.hasRealmRole('admin')) {
                            requestadmin();
                        }
                        updateCategorie();
                    }
                }).catch(function (error) {
                    console.error('Échec de l\'initialisation de Keycloak', error);
                });
            }

            function requestclient() {
                axios.get("http://localhost:8888/api/client", {
                    headers: {
                        'Authorization': 'Bearer ' + keycloak.token
                    }
                })
                    .then(function (response) {
                        console.log("Réponse: ", response.status);
                    })
                    .catch(function (error) {
                        console.log('Rafraîchissement du token');
                        keycloak.updateToken(5).then(function () {
                            console.log('Token rafraîchi');
                        }).catch(function () {
                            console.log('Échec du rafraîchissement du token');
                        })
                    });
            }

            function requestadmin() {
                axios.get("http://localhost:8888/api/admin", {
                    headers: {
                        'Authorization': 'Bearer ' + keycloak.token
                    }
                })
                    .then(function (response) {
                        console.log("Réponse: ", response.status);
                    })
                    .catch(function (error) {
                        console.log('Rafraîchissement du token');
                        keycloak.updateToken(5).then(function () {
                            console.log('Token rafraîchi');
                        }).catch(function () {
                            console.log('Échec du rafraîchissement du token');
                        })
                    });
            }

            function updateCategorie() {
                const BarreCategorie = document.getElementById('BarreCategorie');
                if (!BarreCategorie) {
                    console.error('BarreCategorie élément non trouvé');
                    return;
                }
                BarreCategorie.innerHTML = "";
                axios.get("http://localhost:8888/api/getcategorie", {
                    headers: {
                        'Authorization': 'Bearer ' + keycloak.token
                    }
                })
                    .then(function (response) {
                        console.log("Réponse: ", response.status);
                        for (let i in response.data) {
                            const div = document.createElement('div'); // Créez une nouvelle division pour chaque catégorie
                            div.className = 'sf-header__mobile_item';
                            div.textContent = response.data[i].nom;
                            div.addEventListener('click', function () {
                                showArticles(response.data[i].id);
                            });
                            BarreCategorie.appendChild(div);
                        }
                    })
                    .catch(function (error) {
                        console.log('Erreur: ', error);
                        keycloak.updateToken(5).then(function () {
                            console.log('Token rafraîchi');
                            updateCategorie();
                        }).catch(function () {
                            console.log('Échec du rafraîchissement du token');
                        });
                    });
            }

            function showArticles(id_categorie) {
                const productContainer = document.getElementById("product-container");
                productContainer.innerHTML = "";
                axios.get("http://localhost:8888/api/selectarticle?id_categorie=" + id_categorie, {
                    headers: {
                        'Authorization': 'Bearer ' + keycloak.token
                    }
                })
                    .then(function (response) {
                        console.log("Réponse: ", response.status);
                        console.log(response.data);
                        response.data.forEach(article => {
                            const product = {
                                id: article.id,
                                image: article.image || "images/Biere.png",
                                name: article.nom,
                                price: article.prix + "$",
                                color: article.color || 'rgb(214,232,206)',
                                colorText: article.colorText || '3%'
                            };
                            productContainer.innerHTML += generateProductHTML(product);
                        });
                    })
                    .catch(function (error) {
                        console.log('Erreur: ', error);
                        keycloak.updateToken(5).then(function () {
                            console.log('Token rafraîchi');
                            showArticles(id_categorie);
                        }).catch(function () {
                            console.log('Échec du rafraîchissement du token');
                        });
                    });
            }

            function initScrollToTop() {
                const scrollToTopButton = document.getElementById('scroll-to-top-button');

                scrollToTopButton.addEventListener('click', function () {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });

                function toggleScrollToTopButton() {
                    console.log(window.scrollY);
                    if (window.scrollY > 0) {
                        scrollToTopButton.style.opacity = '1';
                    } else {
                        scrollToTopButton.style.opacity = '0';
                    }
                }

                toggleScrollToTopButton();
                window.addEventListener('scroll', toggleScrollToTopButton);
            }

            function generateProductHTML(product) {
                return `
                    <div class="product">
                        <img src="${product.image}" alt="${product.name}">
                        <div class="product-details">
                            <span>${product.name}</span>
                            <span>${product.price}</span>
                        </div>
                        <button onclick="changementProduit(${product.id}, 1)">
                            <img src="images/panier.png" alt="Ajouter au panier" class="icon">
                        </button>
                    </div>
                `;
            }

            document.getElementById('panier-button').addEventListener('click', function () {
                var paniersection = document.getElementById('panier-section');
                if (paniersection.classList.contains('hidden')) {
                    paniersection.classList.remove('hidden');
                    paniersection.classList.add('visible');
                    generatePanierHTML();
                } else {
                    paniersection.classList.remove('visible');
                    paniersection.classList.add('hidden');
                }
            });

            function getCartItemsFromStorage() {
                const cartItemsJson = localStorage.getItem('cartItems');
                return cartItemsJson ? JSON.parse(cartItemsJson) : [];
            }

            function saveCartItemsToStorage(cartItems) {
                localStorage.setItem('cartItems', JSON.stringify(cartItems));
            }

            function removeFromCart(idProduit) {
                cartItems = cartItems.filter(item => item.idProduit !== idProduit);
                generatePanierHTML();
            }

            let cartItems = getCartItemsFromStorage();

            window.changementProduit = function (idProduit, changement) {
                idProduit = parseInt(idProduit);

                const existingItem = cartItems.find(item => item.idProduit === idProduit);

                if (existingItem) {
                    existingItem.quantity += changement;
                    if (existingItem.quantity < 1) {
                        removeFromCart(existingItem.idProduit)
                    }
                } else {
                    if (changement > 0) {
                        cartItems.push({ idProduit, quantity: changement });
                    }
                }
                console.log(cartItems)
                generatePanierHTML()
            }

            function generatePanierHTML() {
                const icalPanierContainer = document.getElementById('ical-panier');
                icalPanierContainer.innerHTML = '';

                if (cartItems.length === 0) {
                    icalPanierContainer.innerHTML = 'Votre panier est actuellement vide.';
                } else {
                    cartItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('cart-item');
                        itemDiv.innerHTML = `
                            <p>Product ID: ${item.idProduit}</p>
                            <div class="add-section">
                                <button class="button_img button_center" onclick="changementProduit(${item.idProduit}, -1)">-</button>
                                <p class="button_img button_center">${item.quantity}</p>
                                <button class="button_img button_center" onclick="changementProduit(${item.idProduit}, 1)">+</button>
                            </div>
                            <button class="remove-button" onclick="removeFromCart(${item.idProduit})">
                                <svg class="w-[20px] h-[20px]" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                                    <path d="M135.168 64h177.664L330.944 96H384c17.664 0 32 14.336 32 32v32c0 17.664-14.336 32-32 32H64c-17.664 0-32-14.336-32-32V128c0-17.664 14.336-32 32-32h53.056l18.112-32zm-22.336 64H128v32h192v-32h15.168l13.44 32H96.768l13.44-32h2.624zM432 224v256c0 35.328-28.672 64-64 64H80c-35.328 0-64-28.672-64-64V224h416zM304 352c0-17.664-14.336-32-32-32H176c-17.664 0-32 14.336-32 32v80h160v-80z"/>
                                </svg>
                            </button>
                        `;
                        icalPanierContainer.appendChild(itemDiv);
                    });
                }
            }

            function initHorloge() {
                function getTime() {
                    const now = new Date();
                    const heures = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const secondes = String(now.getSeconds()).padStart(2, '0');
                    return `${heures}:${minutes}:${secondes}`;
                }

                function afficherHeure() {
                    const horloge = document.getElementById('horloge');
                    horloge.textContent = getTime();
                }

                afficherHeure();
                setInterval(afficherHeure, 1000);
            }

            function initModal() {
                function openModal() {
                    document.getElementById('ical').style.display = 'block';
                    document.body.classList.add('modal-open');
                    generatePanierHTML();
                }

                function closeModal() {
                    document.getElementById('ical').style.display = 'none';
                    document.body.classList.remove('modal-open');
                }

                window.onclick = function (event) {
                    if (event.target === document.getElementById('ical')) {
                        closeModal();
                    }
                }

                const cartButton = document.querySelector('a[data-event-button="panier-button"]');
                if (cartButton) {
                    cartButton.addEventListener('click', function (event) {
                        event.preventDefault();
                        openModal();
                    });
                }

                const closeModalButton = document.getElementById('close-modal-button');
                if (closeModalButton) {
                    closeModalButton.addEventListener('click', function (event) {
                        event.preventDefault();
                        closeModal();
                    });
                }

                const otherButtons = document.querySelectorAll('a[data-event-button]:not([data-event-button="panier-button"])');
                otherButtons.forEach(function (button) {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();
                        const buttonType = event.currentTarget.getAttribute('data-event-button');

                        switch (buttonType) {
                            case 'wish-count':
                                console.log('Bouton de souhait cliqué');
                                alert('Article ajouté à votre liste de souhaits !');
                                break;
                            case 'account':
                                console.log('Bouton de compte cliqué');
                                alert('Tentative de connexion !');
                                break;
                            default:
                                console.log('Bouton inconnu cliqué');
                        }
                    });
                });
            }

            initKeycloak();
            initScrollToTop();
            initHorloge();
            initModal();
            showArticles(1);
        });
    </script>
</body>

</html>
